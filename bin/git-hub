#!/usr/bin/env bash
#
# Copyright (c) 2012 Wil Moore III <wil.moore@wilmoore.com>
#
# Browse to corresponding repository web page assuming github.com compatible URL scheme

SUBDIRECTORY_OK=Yes
OPTIONS_SPEC="\
git hub [ --contributors | --issues | --pull-request | --stargazers | --wiki ]
--
c,contributors  go to contributors list
i,issues        go to issue tracker
p,pull-request  new pull request from current branch
s,stargazers    go to stargazers list
w,wiki          go to wiki pages
force-origin    force origin
"

. git-sh-setup
. git-sh-i18n

require_work_tree_exists

upstream_url()
{
  local URL=$(git config --get remote.upstream.url)
  echo $(echo ${URL} | tr ':' '/' | sed -e 's@.git$@@' -e 's/^[^@]*@//')
}

origin_url()
{
  local URL=$(git config --get remote.origin.url)
  echo $(echo ${URL} | tr ':' '/' | sed -e 's@.git$@@' -e 's/^[^@]*@//')
}

upstream_or_origin()
{
  if [ ! -z "$(upstream_url)" ]; then
    echo $(upstream_url)
  else
    echo $(origin_url)
  fi
}

CURRENT_BRANCH=$(git describe --contains --all HEAD)
FORCE_ORIGIN=0

for opt
do
  if [ ${opt} = '--force-origin' ]; then
    FORCE_ORIGIN=1
  fi
done


for opt
do

  case "$opt" in

    -c|--contributors)

      if [[ $FORCE_ORIGIN -eq 1 ]]; then
        open http://$(origin_url)/graphs/contributors
      else
        open http://$(upstream_or_origin)/graphs/contributors
      fi

      break
      ;;

    -i|--issues)

      if [[ $FORCE_ORIGIN -eq 1 ]]; then
        open http://$(origin_url)/issues
      else
        open http://$(upstream_or_origin)/issues
      fi

      break
      ;;

    -p|--pull-request)

      if [ ! -z "$CURRENT_BRANCH" ]; then
        open http://$(origin_url)/pull/new/$CURRENT_BRANCH
      else
        open http://$(origin_url)/pull/new
      fi

      break
      ;;

    -s|--stargazers)

      if [[ $FORCE_ORIGIN -eq 1 ]]; then
        open http://$(origin_url)/stargazers
      else
        open http://$(upstream_or_origin)/stargazers
      fi

      break
      ;;

    -w|--wiki)

      if [[ $FORCE_ORIGIN -eq 1 ]]; then
        open http://$(origin_url)/wiki
      else
        open http://$(upstream_or_origin)/wiki
      fi

      break
      ;;

    -h|--help-all)
      usage
      ;;

    *)

      if [ ! -z "$CURRENT_BRANCH" ]; then
        open http://$(origin_url)/tree/$CURRENT_BRANCH
      else
        open http://$(origin_url)
      fi

      break
      ;;

  esac
done

